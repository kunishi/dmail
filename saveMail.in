#! /bin/sh -
# @configure_input@

### Configuration Part ###
# User Dependent Part
. @dmail_scriptdir@/config-@dmail_mlname@.sh

TOP_DIR=$SCRIPTDIR/dmail
LOCK_FILE=$TOP_DIR/lock
SAVE_FILE=$TOP_DIR/drafts
### End of Configuration Part ###

# DO NOT modify below if you don't know enough about how this script works.

# OS Dependent Part (automatically generated by configure)
AWK=@dmail_awk@
CAT=@dmail_cat@
CHMOD=@dmail_chmod@
CP=@dmail_cp@
ECHO=@dmail_echo@
MV=@dmail_mv@
RM=@dmail_rm@
SLEEP=@dmail_sleep@
TOUCH=@dmail_touch@

trap "$RM -f $SAVE_FILE; $MV -f $SAVE_FILE~ $SAVE_FILE; $RM -f $LOCK_FILE; \
	exit 1" 2 3 10 11 15

while [ -f "$LOCK_FILE" ]; do
	$SLEEP 5
done
$TOUCH $LOCK_FILE

if [ ! -f "$SAVE_FILE" ]; then
	$TOUCH $SAVE_FILE
else
	$RM -f $SAVE_FILE~
	$MV -f $SAVE_FILE $SAVE_FILE~
	$CP $SAVE_FILE~ $SAVE_FILE
fi
$CHMOD 644 $SAVE_FILE

$ECHO =========================== >> $SAVE_FILE
$ECHO " " >> $SAVE_FILE
$CAT - | $AWK '\
BEGIN {eoh = 0; rcvd = 0; cnt = 0; rfrnce = 0;}\
/^From / {next;}\
/^Received:/ {rcvd = 1; next;}\
/^[ 	]/ && rcvd == 1 {next;}\
{rcvd = 0;}\
/^Return-Path:/ {next;}\
/^Reply-To:/ && eoh == 0 {next;}\
/^Errors-To:/ && eoh == 0 {next;}\
/^MIME-Version:/ && eoh == 0 {next;}\
/^Mime-Version:/ && eoh == 0 {next;}\
/^Content-Type:/ && eoh == 0 {next;}\
/^In-Reply-To:/ && eoh == 0 {cnt = 1; next;}\
/^References:/ && eoh == 0 {cnt = 1; next;}\
/^[ 	]/ && cnt == 1 {next;}\
{cnt = 0;}\
/^$/ && eoh == 0 {print; eoh = 1; next;}\
{print;}' >> $SAVE_FILE
$ECHO " " >> $SAVE_FILE

$RM -f $LOCK_FILE
